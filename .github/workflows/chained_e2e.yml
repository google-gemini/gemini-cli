steps:
  - name: 'Checkout'
    uses: 'actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955' # ratchet:actions/checkout@v5
    with:
      ref: '${{ needs.parse_run_context.outputs.sha }}'
      repository: '${{ needs.parse_run_context.outputs.repository }}'

  - name: 'Set up Node.js 20.x'
    uses: 'actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020' # ratchet:actions-node@v4
    with:
      node-version: '20.x'
      cache: 'npm'

  - name: 'Configure Windows Defender exclusions'
    run: |
      Add-MpPreference -ExclusionPath $env:GITHUB_WORKSPACE -Force
      Add-MpPreference -ExclusionPath "$env:GITHUB_WORKSPACE\node_modules" -Force
      Add-MpPreference -ExclusionPath "$env:GITHUB_WORKSPACE\packages" -Force
      Add-MpPreference -ExclusionPath "$env:TEMP" -Force
    shell: 'pwsh'

  - name: 'Configure npm for Windows performance'
    run: |
      npm config set progress false
      npm config set audit false
      npm config set fund false
      npm config set loglevel error
      npm config set maxsockets 32
      npm config set registry https://registry.npmjs.org/
    shell: 'pwsh'

  - name: 'Install dependencies'
    run: 'npm ci'
    shell: 'pwsh'

  - name: 'Build project'
    run: 'npm run build'
    shell: 'pwsh'

  - name: 'Run E2E tests'
    env:
      GEMINI_API_KEY: '${{ secrets.GEMINI_API_KEY }}'
      KEEP_OUTPUT: 'true'
      SANDBOX: 'sandbox:none'
      VERBOSE: 'true'
      NODE_OPTIONS: '--max-old-space-size=32768 --max-semi-space-size=256'
      UV_THREADPOOL_SIZE: '32'
      NODE_ENV: 'test'
    shell: 'pwsh'
    run: 'npm run test:integration:sandbox:none'

