name: "CodeQL Smart Analysis"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * 0"  # Weekly Sunday run
  workflow_dispatch:

concurrency:
  group: codeql-analysis
  cancel-in-progress: false

jobs:
  analyze:
    name: Smart CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      # â¬‡ï¸ Get your repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ§  Detect repositoryâ€™s primary languages using GitHubâ€™s Linguist
      - name: Detect Repository Languages
        id: detect_lang
        run: |
          echo "Detecting repo languages..."
          curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/languages" \
            | jq -r 'keys | map(ascii_downcase) | join(",")' > detected_langs.txt

          detected=$(cat detected_langs.txt)
          echo "Detected languages: $detected"
          if [ -z "$detected" ]; then
            echo "No languages detected â€” defaulting to javascript."
            echo "language=javascript" >> $GITHUB_OUTPUT
          else
            # Map GitHub language keys to CodeQL-compatible identifiers
            langs=""
            for lang in $(echo $detected | tr "," " "); do
              case "$lang" in
                javascript|typescript) langs="${langs},javascript" ;;
                python) langs="${langs},python" ;;
                java) langs="${langs},java" ;;
                c|cpp|c++) langs="${langs},cpp" ;;
                c#|csharp) langs="${langs},csharp" ;;
                go) langs="${langs},go" ;;
              esac
            done
            langs=$(echo $langs | sed 's/^,//')
            echo "language=$langs" >> $GITHUB_OUTPUT
            echo "Languages prepared for CodeQL: $langs"
          fi

      # ğŸ§© Initialize CodeQL with detected languages
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.detect_lang.outputs.language }}
          queries: +security-and-quality

      # ğŸ§± Try to build automatically if needed (Java, C++, C#, etc.)
      - name: Autobuild Project
        uses: github/codeql-action/autobuild@v3

      # ğŸ§  If autobuild fails, you can manually specify build commands:
      # - name: Manual Build
      #   run: |
      #     npm ci && npm run build
      #     # or pip install -r requirements.txt
      #     # or mvn package

      # ğŸ” Perform static analysis and upload results
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          upload: true
          category: "/auto:detected"

      # âœ… Log results for workflow summary
      - name: Summary
        run: |
          echo "âœ… CodeQL smart scan complete."
          echo "Results available in Security â†’ Code scanning alerts."
