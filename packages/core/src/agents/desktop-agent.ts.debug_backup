/**
 * @license
 * Copyright 2026 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import { z } from 'zod';
import type { Config } from '../config/config.js';
import type { LocalAgentDefinition } from './types.js';

const DesktopAgentSchema = z.object({
  action_summary: z.string().describe('Summary of the graphical actions taken.'),
});

export const DesktopAgent = (config: Config): LocalAgentDefinition<typeof DesktopAgentSchema> => ({
  kind: 'local',
  name: 'desktop_agent',
  displayName: 'Desktop Agent',
  description: 'Specialized agent for OS-level automation and GUI interaction. Uses computer control tools to interact with apps, windows, and desktop elements.',
  inputConfig: {
    inputSchema: {
      type: 'object',
      properties: { instruction: { type: 'string', description: 'The GUI task to perform (e.g. "open notepad and type hello").' } },
      required: ['instruction'],
    },
  },
  outputConfig: {
    outputName: 'action_summary',
    description: 'Summary of the GUI status or results.',
    schema: DesktopAgentSchema,
  },
  modelConfig: { model: 'inherit' },
  get toolConfig() {
    // Broad matching for GUI/Control tools
    const mcpTools = config.getToolRegistry().getAllToolNames().filter(n => 
      n.includes('screen') || n.includes('mouse') || n.includes('keyboard') || n.includes('click') || n.includes('window') || n.includes('tap') || n.includes('type')
    );
    return { tools: ['workspace_snapshot', ...mcpTools] };
  },
  get promptConfig() {
    return {
      systemPrompt: 'You are a Desktop Automation Expert. Your goal is to navigate and control the host operating system. You use vision (screen_capture) and control (mouse/keyboard) tools. Always verify state via screen_capture after significant moves.',
      query: 'OS Task: ${instruction}',
    };
  },
  runConfig: { maxTurns: 25 },
});
