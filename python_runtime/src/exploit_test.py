
# python_runtime/src/exploit_test.py
# The Red Team: Verifies that the Sovereign Gate holds.

import unittest
import os
import sys
import shutil

# Patch path to allow imports from src
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.tools.create_file import create_file
from ledger_seal import sanitize_job_id, seal_ledger
from src.governance.sovereign_manifest import SovereignJobManifest
from src.governance.sentient_lock import SentientLock

# A "Strong" justification that passes the Sentient Lock (Resonance Check > 5.0)
# Anchors: required, verified, structural, integrity, absolute, mechanics.
STRONG_JUSTIFICATION = "This operation is required and verified to test the structural integrity of the absolute path mechanics."

class TestSovereignSecurity(unittest.TestCase):

    def test_create_file_path_traversal(self):
        print("\n[TEST] Attempting Path Traversal via create_file...")
        try:
            create_file("../pwned.txt", "hacked", justification=STRONG_JUSTIFICATION)
            self.fail("Security Violation: Path traversal was allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked: {e}")
            # Should be blocked by the Tool Validator, not Sentient Lock
            self.assertIn("Path traversal detected", str(e))
            self.assertNotIn("SENTIENT LOCK", str(e))

    def test_create_file_absolute_path(self):
        print("\n[TEST] Attempting Absolute Path Write via create_file...")
        try:
            create_file("/tmp/pwned.txt", "hacked", justification=STRONG_JUSTIFICATION)
            self.fail("Security Violation: Absolute path was allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked: {e}")
            self.assertIn("Absolute paths are forbidden", str(e))
            self.assertNotIn("SENTIENT LOCK", str(e))

    def test_create_file_sensitive_file(self):
        print("\n[TEST] Attempting to Overwrite Sensitive File (.bashrc)...")
        try:
            create_file(".bashrc", "alias ls='rm -rf /'", justification=STRONG_JUSTIFICATION)
            self.fail("Security Violation: Sensitive file overwrite allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked: {e}")
            self.assertIn("Access to sensitive system files is blocked", str(e))
            self.assertNotIn("SENTIENT LOCK", str(e))

    def test_sentient_lock_engagement(self):
        print("\n[TEST] Verifying Sentient Lock (Resonance Check)...")
        weak_justification = "I think maybe we could try this."
        try:
            create_file("safe.txt", "content", justification=weak_justification)
            self.fail("Security Violation: Weak justification allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked by Lock: {e}")
            self.assertIn("SENTIENT LOCK ENGAGED", str(e))
            self.assertIn("maybe", str(e))

    def test_ledger_seal_sanitization(self):
        print("\n[TEST] Verifying Ledger Seal Filename Sanitization...")
        evil_job_id = "../../../etc/passwd"
        sanitized = sanitize_job_id(evil_job_id)
        print(f"Input: {evil_job_id}")
        print(f"Sanitized: {sanitized}")

        self.assertNotIn("..", sanitized)
        self.assertNotIn("/", sanitized)
        self.assertEqual(sanitized, "etc_passwd")

if __name__ == '__main__':
    print("=== SOVEREIGN SECURITY VERIFICATION ===")
    unittest.main()
