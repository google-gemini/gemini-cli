
# python_runtime/src/exploit_test.py
# The Red Team: Verifies that the Sovereign Gate holds.

import unittest
import os
import sys
import shutil

# Patch path to allow imports from src
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.tools.create_file import create_file
from ledger_seal import sanitize_job_id, seal_ledger
from src.governance.sovereign_manifest import SovereignJobManifest

class TestSovereignSecurity(unittest.TestCase):

    def test_create_file_path_traversal(self):
        print("\n[TEST] Attempting Path Traversal via create_file...")
        try:
            create_file("../pwned.txt", "hacked", justification="Testing security constraints for path traversal.")
            self.fail("Security Violation: Path traversal was allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked: {e}")
            self.assertIn("Path traversal detected", str(e))

    def test_create_file_absolute_path(self):
        print("\n[TEST] Attempting Absolute Path Write via create_file...")
        try:
            create_file("/tmp/pwned.txt", "hacked", justification="Testing security constraints for absolute path.")
            self.fail("Security Violation: Absolute path was allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked: {e}")
            self.assertIn("Absolute paths are forbidden", str(e))

    def test_create_file_sensitive_file(self):
        print("\n[TEST] Attempting to Overwrite Sensitive File (.bashrc)...")
        try:
            create_file(".bashrc", "alias ls='rm -rf /'", justification="Testing sensitive file protection.")
            self.fail("Security Violation: Sensitive file overwrite allowed!")
        except ValueError as e:
            print(f"[SUCCESS] Blocked: {e}")
            self.assertIn("Access to sensitive system files is blocked", str(e))

    def test_ledger_seal_sanitization(self):
        print("\n[TEST] Verifying Ledger Seal Filename Sanitization...")
        evil_job_id = "../../../etc/passwd"
        sanitized = sanitize_job_id(evil_job_id)
        print(f"Input: {evil_job_id}")
        print(f"Sanitized: {sanitized}")

        self.assertNotIn("..", sanitized)
        self.assertNotIn("/", sanitized)
        self.assertEqual(sanitized, "etc_passwd") # Expected based on my implementation (stripped leading/trailing underscores, collapsed)

if __name__ == '__main__':
    print("=== SOVEREIGN SECURITY VERIFICATION ===")
    unittest.main()
