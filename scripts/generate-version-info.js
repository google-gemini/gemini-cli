/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs';
import { dirname, join, resolve } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const root = join(__dirname, '..');

// Read version from root package.json
const pkg = JSON.parse(readFileSync(resolve(root, 'package.json'), 'utf-8'));
const version = pkg.version || 'unknown';

function generateVersionFile(packageName, constantName) {
  const generatedDir = join(root, `packages/${packageName}/src/generated`);
  const versionFile = join(generatedDir, 'version.ts');

  if (!existsSync(generatedDir)) {
    mkdirSync(generatedDir, { recursive: true });
  }

  const fileContent = `/**
 * @license
 * Copyright ${new Date().getFullYear()} Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

// This file is auto-generated by the build script.
// Do not edit this file manually.
export const ${constantName} = ${JSON.stringify(version)};
`;

  writeFileSync(versionFile, fileContent);
}

generateVersionFile('cli', 'CLI_VERSION');
generateVersionFile('core', 'CLI_VERSION');
